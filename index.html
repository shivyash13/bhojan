<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Foodie â€” Order & Send to Merchant (WhatsApp)</title>

  <!-- Fonts & icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;500;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <style>
    :root{
      --bg:#0b0c0d; --card:#121318; --muted:#9aa4af;
      --accent:#e23b3b; --accent2:#ff615f; --glass:rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.04);
      --maxw:1200px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:'Montserrat', sans-serif; background:linear-gradient(180deg,var(--bg),#08090a); color:#e8eef2; -webkit-font-smoothing:antialiased;}
    a{ color:inherit }

    /* Header */
    header{ background:linear-gradient(90deg,var(--accent),var(--accent2)); padding:14px 18px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:80; box-shadow:0 8px 24px rgba(0,0,0,0.5); }
    .brand{ display:flex; gap:12px; align-items:center }
    .logo{ width:44px; height:44px; border-radius:10px; background:rgba(255,255,255,0.12); display:flex; align-items:center; justify-content:center; }
    .logo i { font-weight:800; color:white; font-size:20px; }
    .brand-title{ font-weight:800; font-size:18px }
    .nav{ display:flex; gap:10px; align-items:center }
    .btn{ background:rgba(255,255,255,0.95); color:var(--accent); padding:8px 12px; border-radius:10px; font-weight:700; border:none; cursor:pointer }

    /* Container and spacing */
    .container { max-width: var(--maxw); margin: 22px auto; padding: 0 18px; }
    .bar { margin-bottom: 26px; } /* <-- breathing room between info bar and menu */

    .wrap{ max-width:var(--maxw); margin:0 auto; padding:0 18px; display:grid; grid-template-columns: 1fr 380px; gap:22px; align-items:start; }
    @media (max-width:980px){ .wrap{ grid-template-columns:1fr; } .sidebar { order: 2 } }

    .panel{ background:linear-gradient(180deg,var(--card),#0f1114); border-radius:12px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,0.6) }
    .hero{ display:flex; justify-content:space-between; gap:12px; align-items:center; border-radius:10px; padding:14px; margin-bottom:12px; }
    .hero h1{ margin:0; font-size:24px; font-weight:800 }
    .muted{ color:var(--muted) }

    /* Menu Grid */
    .menu-grid{
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap:18px;
    }
    .card{
      display:flex;
      flex-direction:column;
      border-radius:12px;
      overflow:hidden;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
      transition: transform .18s ease, box-shadow .18s ease;
      box-shadow: 0 6px 20px rgba(0,0,0,0.35);
    }
    .card:hover { transform: translateY(-6px); box-shadow: 0 14px 34px rgba(0,0,0,0.5); }
    .thumb{ width:100%; height:160px; overflow:hidden; background: #111; }
    .thumb img{ width:100%; height:100%; object-fit:cover; display:block; }
    .meta{ padding:12px; display:flex; flex-direction:column; gap:8px; }
    .meta h3{ margin:0 0 2px 0; font-size:16px }
    .meta p{ margin:0; color:var(--muted); font-size:13px; line-height:1.2; min-height:38px }
    .card-footer{ display:flex; align-items:center; justify-content:space-between; margin-top:8px }
    .price{ font-weight:800; font-size:15px }
    .add-btn{ background:linear-gradient(90deg,var(--accent),var(--accent2)); border:none; color:white; padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:800 }

    /* Sidebar (cart) */
    .sidebar .cart-title{ font-weight:800; font-size:18px; margin-bottom:8px }
    .cart-list{ max-height:320px; overflow:auto; display:flex; flex-direction:column; gap:10px; padding-right:6px }
    .cart-item{ display:flex; justify-content:space-between; align-items:center; padding:10px; border-radius:8px; background:var(--glass-2) }
    .qty-controls{ display:flex; gap:8px; align-items:center }
    .qc{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; padding:6px 8px; border-radius:6px; cursor:pointer }
    .total-row{ display:flex; justify-content:space-between; margin-top:10px; font-weight:800; font-size:16px }
    .field{ margin-top:10px }
    .input{ width:100%; padding:10px; background:transparent; border-radius:8px; border:1px solid rgba(255,255,255,0.06); color:inherit }
    .row{ display:flex; gap:8px }
    .loc-btn{ flex:1; background:transparent; border:1px dashed rgba(255,255,255,0.08); color:var(--muted); padding:10px; border-radius:8px; cursor:pointer }
    .send-btn{ flex:1; background:linear-gradient(90deg,var(--accent2),var(--accent)); color:white; padding:10px; border-radius:8px; border:none; cursor:pointer; font-weight:800 }
    .note{ margin-top:8px; color:var(--muted); font-size:13px }
    .small{ font-size:13px; color:#e8eef2 }
    .center{ text-align:center }
    .open-map{ color:#8fd6ff; text-decoration:none; font-weight:700 }

    /* Sticky on desktop */
    @media(min-width:981px){
      .sidebar .panel { position:sticky; top:90px; }
    }

    /* Drawer for mobile */
    @media(max-width:980px){
      .sidebar {
        position: fixed;
        top: 0;
        right: -100%;
        width: 88%;
        max-width: 420px;
        height: 100%;
        background: var(--card);
        padding: 20px;
        transition: right 0.28s ease;
        z-index: 120;
        overflow-y: auto;
      }
      .sidebar.open { right: 0; }
    }

    /* Floating cart button */
    .floating-cart {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: linear-gradient(90deg,var(--accent2),var(--accent));
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 999px;
      font-weight:800;
      display:flex;
      gap:8px;
      align-items:center;
      z-index:200;
      cursor:pointer;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    /* minor responsive tweaks */
    @media (max-width:560px){
      .meta p { min-height:44px; font-size:13px }
      .thumb{ height:150px }
    }
  </style>
</head>
<body>

<header>
  <div class="brand">
    <div class="logo"><i class="fas fa-utensils"></i></div>
    <div>
      <div class="brand-title">BHOJAN</div>
      <div class="small">Bhookh Lagi? Hum Hain Na!</div>
    </div>
  </div>
  <div class="nav">
    <a class="small" href="#menu" style="color:white;text-decoration:none;margin-right:12px">Menu</a>
    <button class="btn" id="open-cart">Open Cart
      <span id="cart-count" style="margin-left:8px;background:#fff;color:var(--accent);padding:4px 8px;border-radius:8px;font-weight:800">0</span>
    </button>
  </div>
</header>

<div class="container">
  <div class="bar panel">
    <div style="display:flex;flex-direction:column;gap:6px">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div style="font-weight:800">Order Hot & Fresh â€” Delivered to your Door Step</div>
        <div class="muted small">Open now â€¢ Delivery in 30â€“45 min</div>
      </div>
      <div class="muted">Select items, share live location and send order directly to merchant's WhatsApp.</div>
    </div>
  </div>
</div>

<div class="wrap">
  <main>
    <div class="panel hero">
      <div>
        <h1 style="margin-bottom:6px">Our Menu</h1>
        <div class="muted">Tap add to include an item in the cart.</div>
      </div>
    </div>

    <section id="menu" class="panel">
      <div id="menu-grid" class="menu-grid"><div class="muted">Loading menu from our kitchen...</div></div>
    </section>
  </main>

  <aside class="sidebar" aria-hidden="true">
    <div class="panel">
      <div class="cart-title">Your Cart</div>
      <div id="cart-list" class="cart-list"><div class="muted">Cart is empty â€” add items from menu.</div></div>

      <div class="total-row">
        <div class="small">Total</div>
        <div id="cart-total">â‚¹0</div>
      </div>

      <div class="field">
        <input id="cust-name" class="input" placeholder="Your name" />
      </div>
      <div class="field">
        <input id="cust-mobile" class="input" placeholder="Your mobile (for merchant to contact)" />
      </div>
      <div class="field">
        <input id="cust-address" class="input" placeholder="Address (optional - fallback if location not shared)" />
      </div>

      <div class="field" style="margin-top:12px">
    <div class="row">
        <button id="loc-btn" class="loc-btn" title="Share live GPS location">
            <i class="fas fa-location-dot"></i> Share Location
        </button>
        <button id="send-btn" class="send-btn" title="Send order to merchant via WhatsApp">
            <i class="fab fa-whatsapp"></i> Send Order
        </button>
    </div>
</div>

      <div id="loc-status" class="note">No location shared yet. When you click <strong>Share my current location</strong>, allow the browser to use GPS. The send button will also request location if not already shared.</div>
      <div id="order-msg" class="note"></div>
    </div>
  </aside>
</div>

<button class="floating-cart" id="floating-cart">
  <i class="fas fa-shopping-cart"></i>
  <span id="float-count">0</span>
</button>

<script>
/* ============================
  CONFIG
============================ */
// Merchant phone (local) and full with country code
const MERCHANT_NUMBER_LOCAL = '8080935258';
const MERCHANT_FULL = '91' + MERCHANT_NUMBER_LOCAL.replace(/\D/g, '');

// Sanity (replace token to enable writes)
const SANITY_PROJECT_ID = "1c72zgt0";
const SANITY_DATASET = "production";
const SANITY_WRITE_TOKEN = "skUVMVJY4twON8ykeosVKz8IvFCflMpiOeBSw1l7F6K6ITNo1jtskeTI04GZLBB5vC0f3AxZ7lmDMm3PiUUfJ3IgqRugM62FiamP6s5rvke8PNYYvsBBVsSXuh3W2Vv77DP5SaXJtSmc1dfsvi7Kdx9oMe8crkwXdrXqJp4AyEOWBKq5HEay"; // <-- replace to enable saving
const SANITY_QUERY = encodeURIComponent('*[_type == "menuItem"]{name, desc, price, "id": _id, "img": img.asset->url}');
const SANITY_URL = `https://${SANITY_PROJECT_ID}.api.sanity.io/v2021-10-21/data/query/${SANITY_DATASET}?query=${SANITY_QUERY}`;

/* ============================
  STATE
============================ */
let MENU = [];
let CART = [];
let LOCATION = { lat: null, lng: null, mapsUrl: null };

/* Helpers */
const el = id => document.getElementById(id);
const money = v => Math.round(Number(v || 0)); // simple integer rupee rounding

/* ============================
  RENDER MENU + CART
============================ */
function renderMenu() {
  const grid = el('menu-grid'); grid.innerHTML = '';
  if (!MENU || MENU.length === 0) {
    grid.innerHTML = '<div class="muted center">No menu available right now.</div>';
    return;
  }
  MENU.forEach(it => {
    const card = document.createElement('div'); card.className = 'card';
    card.innerHTML = `
      <div class="thumb"><img src="${it.img || placeholderImage(it.name)}" alt="${escapeHtml(it.name)}"></div>
      <div class="meta">
        <h3>${escapeHtml(it.name)}</h3>
        <p>${escapeHtml(it.desc || '')}</p>
        <div class="card-footer">
          <div class="price">â‚¹${money(it.price)}</div>
          <!-- action slot replaces static Add button -->
          <div class="add-area" data-id="${it.id}"></div>
        </div>
      </div>
    `;
    grid.appendChild(card);
    // render Add or Qty controls based on current cart state
    renderAction(it.id);
  });
  // NOTE: we no longer attach listeners to '.add-btn' here;
  // they are attached inside renderAction() for each item.
}

/* Render +Add or âˆ’ qty + inside the card for a given item */
function renderAction(id) {
  const slot = document.querySelector(`.add-area[data-id="${id}"]`);
  if (!slot) return;
  const existing = CART.find(c => c.id === id);
  if (existing && existing.qty > 0) {
    // show quantity controls (reuse existing .qty-controls and .qc styles)
    slot.innerHTML = `
      <div class="qty-controls">
        <button class="qc dec" data-id="${id}" aria-label="decrease">âˆ’</button>
        <div class="small" style="min-width:18px;text-align:center">${existing.qty}</div>
        <button class="qc inc" data-id="${id}" aria-label="increase">+</button>
      </div>
    `;
    const dec = slot.querySelector('.dec');
    const inc = slot.querySelector('.inc');
    dec.addEventListener('click', () => changeQty(id, -1));
    inc.addEventListener('click', () => changeQty(id, +1));
  } else {
    // show + Add button
    slot.innerHTML = `<button class="add-btn" data-id="${id}"><span style="font-weight:900;margin-right:4px">+</span> Add</button>`;
    const btn = slot.querySelector('.add-btn');
    btn.addEventListener('click', () => addToCart(id));
  }
}

/* Utility to avoid empty images */
function placeholderImage(seed = '') {
  const s = encodeURIComponent(seed || 'food');
  return `https://picsum.photos/seed/${s}/600/400`;
}

/* Escape text to avoid HTML injection */
function escapeHtml(s) {
  if (!s) return '';
  return String(s)
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

/* CART logic */
function addToCart(id) {
  const item = MENU.find(m => m.id === id);
  if (!item) return;
  const existing = CART.find(c => c.id === id);
  if (existing) existing.qty++;
  else CART.push({ id: item.id, name: item.name, price: item.price, qty: 1 });
  saveCart(); renderCart();
  renderAction(id); // keep the card button in sync (turn into qty controls)
  showTempMessage(`${item.name} added to cart`);
}

function changeQty(id, delta) {
  const it = CART.find(c => c.id === id); 
  if (!it) return;
  it.qty += delta; 
  if (it.qty <= 0) CART = CART.filter(c => c.id !== id);
  saveCart(); renderCart();
  renderAction(id); // update the card button (back to + Add if 0)
}

function cartTotal() { return CART.reduce((s, i) => s + (Number(i.price) || 0) * i.qty, 0); }

function renderCart() {
  const list = el('cart-list'); list.innerHTML = '';
  if (CART.length === 0) {
    list.innerHTML = '<div class="muted">Cart is empty â€” add tasty food.</div>';
  } else {
    CART.forEach(ci => {
      const div = document.createElement('div'); div.className = 'cart-item';
      div.innerHTML = `<div>
                          <div class="name" style="font-weight:700">${escapeHtml(ci.name)}</div>
                          <div class="small">â‚¹${money(ci.price)} Ã— ${ci.qty}</div>
                       </div>
                       <div class="qty-controls">
                         <button class="qc dec" data-id="${ci.id}">âˆ’</button>
                         <button class="qc inc" data-id="${ci.id}">+</button>
                       </div>`;
      list.appendChild(div);
    });
    list.querySelectorAll('.inc').forEach(b => b.addEventListener('click', e => changeQty(e.currentTarget.dataset.id, +1)));
    list.querySelectorAll('.dec').forEach(b => b.addEventListener('click', e => changeQty(e.currentTarget.dataset.id, -1)));
  }
  el('cart-total').innerText = 'â‚¹' + money(cartTotal());
  el('cart-count').innerText = CART.reduce((s, i) => s + i.qty, 0);
  el('float-count').innerText = CART.reduce((s, i) => s + i.qty, 0);
}

/* Persist cart */
function saveCart() { try { localStorage.setItem('demo_cart', JSON.stringify(CART)); } catch(e){} }
function loadCart() { try { const s = localStorage.getItem('demo_cart'); if (s) CART = JSON.parse(s); } catch (e) { CART = []; } }

/* ============================
 GEOLOCATION
============================ */
function captureLocation(highAccuracy = true) {
  const locBtn = el('loc-btn');
  const originalBtnText = 'Share my current location';

  // Set loading state on the button
  locBtn.disabled = true;
  locBtn.innerHTML = 'Fetching Location...';

  return new Promise((resolve, reject) => {
    if (!navigator.geolocation) {
      el('loc-status').innerText = 'Geolocation not supported by your browser.';
      locBtn.disabled = false; // Re-enable on error
      locBtn.innerHTML = originalBtnText; // Reset text
      return reject(new Error('Geolocation not supported'));
    }

    el('loc-status').innerText = 'Getting location...';
    const opts = { enableHighAccuracy: highAccuracy, timeout: 15000, maximumAge: 0 };

    navigator.geolocation.getCurrentPosition(pos => {
      LOCATION.lat = pos.coords.latitude;
      LOCATION.lng = pos.coords.longitude;
      // CORRECTED the Google Maps URL to a valid format
      LOCATION.mapsUrl = `https://maps.google.com/?q=${LOCATION.lat},${LOCATION.lng}`;
      
      el('loc-status').innerHTML = `Location ready â€” <a class="open-map" href="${LOCATION.mapsUrl}" target="_blank">Open in Google Maps</a>`;
      
      // Update button to success state and keep it disabled
      locBtn.innerHTML = 'âœ… Location Shared';
      
      resolve(LOCATION);
    }, err => {
      let msg = 'Could not get location.';
      if (err.code === 1) msg = 'Permission denied.';
      else if (err.code === 2) msg = 'Position unavailable.';
      else if (err.code === 3) msg = 'Location request timed out.';
      el('loc-status').innerText = msg;
      
      // Re-enable the button and reset its text on error
      locBtn.disabled = false;
      locBtn.innerHTML = originalBtnText;
      
      reject(err);
    }, opts);
  });
}
/* ============================
Â  SAVE ORDER -> SECURE ENDPOINT
============================ */
async function saveOrderToEndpoint(orderData) {
    try {
        const response = await fetch('/api/save-order', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(orderData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`Server error: ${response.status} - ${errorText}`);
        }
        
        return await response.json();
    } catch (e) {
        console.error('Could not save order:', e);
        el('order-msg').innerText = 'Warning: Could not save order to server. Order not recorded.';
        throw e;
    }
}

/* ============================
  BUILD WHATSAPP MESSAGE & SEND
============================ */
async function sendOrderToMerchant() {
  const sendBtn = el('send-btn');
  sendBtn.disabled = true;
  el('order-msg').innerText = 'Processing your order...';

  const name = el('cust-name').value.trim();
  const mobile = el('cust-mobile').value.trim();
  const address = el('cust-address').value.trim();

  if (!name || !mobile) {
    el('order-msg').innerText = 'Please enter your name and mobile number.';
    sendBtn.disabled = false;
    return;
  }
  if (CART.length === 0) {
    el('order-msg').innerText = 'Your cart is empty â€” add items first.';
    sendBtn.disabled = false;
    return;
  }

  try {
    if (!LOCATION.lat) await captureLocation(true);
  } catch (e) {
    if (!address) {
      el('order-msg').innerText = 'Could not get GPS. Allow location or enter an address.';
      sendBtn.disabled = false;
      return;
    }
  }

  // Prepare order data for Sanity
  const orderData = {
    customerName: name,
    customerMobile: mobile,
    address: address || 'Not provided',
    locationUrl: LOCATION.mapsUrl || 'Not provided',
    total: cartTotal(),
    items: CART.map(item => ({ name: item.name, qty: item.qty, price: item.price }))
  };

  // This is the new, clean section
// Send the data to our secure endpoint
try {
    await saveOrderToEndpoint(orderData);
    el('order-msg').innerText = 'Order received by server. Preparing to send on WhatsApp...';
} catch (err) {
    el('order-msg').innerText = 'Could not save order to server. Please try again later.';
    sendBtn.disabled = false;
    return;
}

  // Build message lines
  const lines = [];
  lines.push('*ðŸ“¦ New Order â€” TO BHOJAN*');
  lines.push(`*Customer:* ${name}`);
  lines.push(`*Customer Mobile:* ${mobile}`);
  if (address) lines.push(`*Address:* ${address}`);
  if (LOCATION.mapsUrl) lines.push(`*Location:* ${LOCATION.mapsUrl}`);
  lines.push('');
  lines.push('*Items:*');
  CART.forEach(it => lines.push(`${it.name} Ã— ${it.qty} â€” â‚¹${money(it.price * it.qty)}`));
  lines.push('');
  lines.push(`*Total:* â‚¹${money(cartTotal())}`);
  lines.push('');
  lines.push('Please confirm and prepare for delivery. Thank you!');

  const text = encodeURIComponent(lines.join('\n'));
  const waUrl = `https://wa.me/${MERCHANT_FULL}?text=${text}`;
  window.open(waUrl, '_blank');

  el('order-msg').innerText = 'Order sent! Opening WhatsApp...';
  CART = []; saveCart(); renderCart();
  // also update all card actions back to "+ Add"
  MENU.forEach(it => renderAction(it.id));
  sendBtn.disabled = false;
}

/* ============================
  UI helpers
============================ */
function showTempMessage(msg, duration = 2000) {
  const prev = el('order-msg');
  if (!prev) return;
  const old = prev.innerText;
  prev.innerText = msg;
  setTimeout(() => { prev.innerText = old; }, duration);
}

/* ============================
  EVENTS
============================ */
el('loc-btn').addEventListener('click', () => captureLocation(true));
el('send-btn').addEventListener('click', sendOrderToMerchant);

el('open-cart').addEventListener('click', () => {
  toggleCart();
});
el('floating-cart').addEventListener('click', () => {
  toggleCart();
});

/* toggle cart drawer on mobile or highlight on desktop */
function toggleCart(open = null) {
  const sidebar = document.querySelector('.sidebar');
  const isOpen = sidebar.classList.contains('open');
  if (open === true) sidebar.classList.add('open');
  else if (open === false) sidebar.classList.remove('open');
  else sidebar.classList.toggle('open');
  const aria = sidebar.classList.contains('open') ? 'false' : 'true';
  sidebar.setAttribute('aria-hidden', aria);
}

/* ============================
  INITIALIZE APP
============================ */
async function initializeApp() {
  loadCart();
  renderCart();

  // Fetch menu from Sanity, fallback to sample menu on error
  try {
    const response = await fetch(SANITY_URL);
    if (!response.ok) throw new Error('Sanity fetch failed: ' + response.status);
    const data = await response.json();
    MENU = (data.result && data.result.length) ? data.result : sampleMenu();
  } catch (error) {
    console.warn('Could not fetch menu from Sanity â€” using fallback', error);
    MENU = sampleMenu();
  }

  renderMenu();
}

/* Sample fallback menu (used if Sanity fetch fails) */
function sampleMenu() {
  return [
    { id: 'm1', name: 'Paneer Butter Masala', desc: 'Creamy paneer with rich tomato gravy', price: 180, img: placeholderImage('Paneer Butter Masala') },
    { id: 'm2', name: 'Veg Biryani', desc: 'Fragrant basmati rice with veggies and spices', price: 150, img: placeholderImage('Veg Biryani') },
    { id: 'm3', name: 'Chicken Curry', desc: 'Traditional spicy chicken curry', price: 220, img: placeholderImage('Chicken Curry') },
    { id: 'm4', name: 'Masala Dosa', desc: 'Crispy dosa with lightly spiced potato filling', price: 90, img: placeholderImage('Masala Dosa') },
    { id: 'm5', name: 'Schezwan Noodles', desc: 'Spicy Indo-Chinese stir fry noodles', price: 140, img: placeholderImage('Schezwan Noodles') }
  ];
}

/* Kick off */
initializeApp();

</script>
</body>
</html>
